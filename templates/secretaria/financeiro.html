{% extends "includes/_layout.html" %}
{% block title %}Financeiro{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Cabe√ßalho + Filtro de M√™s + Bot√£o Configurar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h4 mb-0">
        <i class="bi bi-cash-stack"></i> Financeiro
      </h2>
      <small class="text-muted">
        üìÖ M√™s Atual:
        <strong>{{ mes_atual }}</strong> ‚Äî
        {% if saldo_final < 0 %}
          <span class="text-danger fw-bold">Situa√ß√£o: NEGATIVA (D√©ficit)</span>
        {% else %}
          <span class="text-success fw-bold">Situa√ß√£o: POSITIVA (Super√°vit)</span>
        {% endif %}
      </small>
    </div>

    <div class="d-flex gap-2">
      <a href="{{ url_for('configurar_financeiro') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-gear"></i> Configurar
      </a>
      <form method="GET" class="d-flex gap-2">
        <input type="month" name="mes" value="{{ mes }}" class="form-control form-control-sm" style="width: 160px;">
        <button type="submit" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
      </form>
    </div>
  </div>

  <!-- Cards de Resumo -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #28a745, #20c997);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Entradas</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(total_entradas) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #dc3545, #fd7e14);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Sa√≠das</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(total_saidas) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Fixos</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(total_fixos) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white {% if saldo_final < 0 %}bg-danger{% else %}bg-primary{% endif %}">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Saldo Final</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(saldo_final) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #17a2b8, #0dcaf0);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Saldo Real</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(saldo_real) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #6f42c1, #9c27b0);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Provis√£o Extras</h6>
          <h3 class="mb-0">R$ {{ "%.2f"|format(provisao_extras) }}</h3>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #fd7e14, #f39c12);">
        <div class="card-body">
          <h6 class="mb-1 opacity-75">Dizimistas Necess√°rios</h6>
          <h3 class="mb-0">{{ dizimistas_necessarios }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Formul√°rio + Gr√°fico -->
  <div class="row g-4">
    {% if form %}
    <!-- Formul√°rio para tesouraria -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Registrar Transa√ß√£o</h6>
        </div>
        <div class="card-body">
          <form method="POST">
            {{ form.hidden_tag() }}
            <div class="mb-2">{{ form.data_transacao.label(class="form-label small") }}{{ form.data_transacao(class="form-control form-control-sm") }}</div>
            <div class="mb-2">{{ form.tipo.label(class="form-label small") }}{{ form.tipo(class="form-select form-select-sm") }}</div>
            <div class="mb-2">{{ form.categoria.label(class="form-label small") }}{{ form.categoria(class="form-control form-control-sm") }}</div>
            <div class="mb-2">{{ form.valor.label(class="form-label small") }}{{ form.valor(class="form-control form-control-sm") }}</div>
            <div class="mb-2">{{ form.metodo.label(class="form-label small") }}{{ form.metodo(class="form-select form-select-sm") }}</div>
            <div class="mb-2">{{ form.membro_id.label(class="form-label small") }}{{ form.membro_id(class="form-select form-select-sm") }}</div>
            <div class="mb-3">{{ form.is_fixo.label(class="form-label small") }}{{ form.is_fixo(class="form-select form-select-sm") }}</div>
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-check2"></i> Registrar
            </button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Visualiza√ß√£o para membros -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100 text-center p-4">
        <div class="card-body">
          <i class="bi bi-lock fs-1 text-muted"></i>
          <p class="mt-3 text-muted small">
            Apenas a tesouraria pode registrar novas transa√ß√µes.<br>
            Aqui voc√™ pode visualizar suas contribui√ß√µes e o saldo do m√™s.
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Gr√°fico -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-graph-up"></i> Saldo Mensal (6 meses)</h6>
        </div>
        <div class="card-body">
          <canvas id="graficoSaldo" height="280"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de Transa√ß√µes -->
  <div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white">
      <h6 class="mb-0"><i class="bi bi-table"></i> Transa√ß√µes do M√™s</h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>M√©todo</th>
              <th class="text-end">Valor</th>
              <th>Fixo?</th>
            </tr>
          </thead>
          <tbody>
            {% if transacoes %}
              {% for t in transacoes %}
              <tr class="{% if t.tipo == 'despesa' %}table-danger{% else %}table-success{% endif %}">
                <td>{{ t.data.strftime('%d/%m/%Y') }}</td>
                <td>{{ t.tipo|title }}</td>
                <td>{{ t.categoria }}</td>
                <td>{{ t.metodo|title }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(t.valor) }}</td>
                <td>{% if t.is_fixo %}<span class="badge bg-primary">Sim</span>{% else %}-{% endif %}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="text-center text-muted py-3">Nenhuma transa√ß√£o encontrada.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('graficoSaldo').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ meses_grafico|tojson }},
        datasets: [{
          label: 'Saldo Real',
          data: {{ saldos_grafico|tojson }},
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          fill: true,
          tension: 0.4
        }]
      }
    });
  });
</script>
{% endblock %}
